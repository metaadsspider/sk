<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>HLS Player (5s Delay Start)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <style>
    body { margin:0; background:#000; color:#fff; font-family:system-ui, Arial, sans-serif; }
    #wrap { max-width:900px; margin:0 auto; padding:10px; }
    video { width:100%; aspect-ratio:16/9; background:#000; }
    .bar { display:flex; gap:8px; align-items:center; margin:8px 0; }
    select, button { padding:6px 10px; border-radius:8px; border:1px solid #333; background:#111; color:#fff; }
    #log { white-space:pre-wrap; font-size:12px; color:#bbb; background:#0b0b0b; padding:8px; border-radius:8px; max-height:140px; overflow:auto; }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/hls.js@1"></script>
</head>
<body>
  <div id="wrap">
    <video id="video" controls playsinline crossorigin="anonymous"></video>

    <div class="bar">
      <label for="levels">Quality:</label>
      <select id="levels"><option>Auto</option></select>
      <button id="live">Go Live</button>
    </div>

    <div id="log"></div>
  </div>

  <script>
    const STREAM_URL = "https://in-mc-fdlive.fancode.com/mumbai/132485_english_hls_21999c231a24628ta-di_h264/index.m3u8";
    const DELAY_SECONDS = 5;

    const v = document.getElementById("video");
    const levelsSel = document.getElementById("levels");
    const liveBtn = document.getElementById("live");
    const logEl = document.getElementById("log");
    let hls;
    let startedDelay = false;

    const log = (...args) => {
      const line = args.map(a => typeof a === "object" ? JSON.stringify(a) : String(a)).join(" ");
      console.log(...args);
      logEl.textContent = line + "\n" + logEl.textContent;
    };

    function init() {
      if (v.canPlayType("application/vnd.apple.mpegurl")) {
        v.src = STREAM_URL;
      } else if (window.Hls && Hls.isSupported()) {
        hls = new Hls({
          lowLatencyMode: true,
          enableWorker: true
        });
        hls.loadSource(STREAM_URL);
        hls.attachMedia(v);

        hls.on(Hls.Events.MANIFEST_PARSED, (_, data) => {
          buildQualityMenu(data.levels);
          v.play().catch(()=>{});
          log("Levels:", data.levels.map(l => (l.height||"")+"p").join(", "));
        });

        hls.on(Hls.Events.FRAG_BUFFERED, () => {
          if (!startedDelay && v.seekable.length) {
            const liveEdge = v.seekable.end(v.seekable.length - 1);
            if (!isNaN(liveEdge) && liveEdge > DELAY_SECONDS) {
              v.currentTime = liveEdge - DELAY_SECONDS;
              startedDelay = true;
              log(`Started ${DELAY_SECONDS}s behind live`);
            }
          }
        });

        hls.on(Hls.Events.ERROR, (_, data) => {
          log("HLS error:", data.type, data.details || "", data?.response?.code || "");
          if (data.fatal) {
            switch (data.type) {
              case Hls.ErrorTypes.NETWORK_ERROR: hls.startLoad(); break;
              case Hls.ErrorTypes.MEDIA_ERROR: hls.recoverMediaError(); break;
              default: hls.destroy(); init(); break;
            }
          }
        });
      } else {
        log("This browser doesnâ€™t support HLS.js / MSE.");
      }
    }

    function buildQualityMenu(levels) {
      levelsSel.innerHTML = "";
      const auto = document.createElement("option");
      auto.value = "auto";
      auto.textContent = "Auto";
      levelsSel.appendChild(auto);

      const usedHeights = new Set();
      levels.forEach((lvl, i) => {
        if (usedHeights.has(lvl.height)) return;
        usedHeights.add(lvl.height);
        const o = document.createElement("option");
        o.value = i;
        o.textContent = (lvl.height || "") + "p";
        levelsSel.appendChild(o);
      });
      levelsSel.value = "auto";
    }

    levelsSel.addEventListener("change", () => {
      if (!hls) return;
      hls.currentLevel = (levelsSel.value === "auto") ? -1 : parseInt(levelsSel.value, 10);
    });

    liveBtn.addEventListener("click", () => {
      if (hls && v.seekable.length) {
        v.currentTime = v.seekable.end(v.seekable.length - 1);
      }
    });

    init();
  </script>
</body>
</html>
